# Изменения: Переключатель AI проверки

## Описание

Добавлен функционал переключения режима AI проверки в комнатах. Теперь можно отключить проверку на AI-генерацию и сосредоточиться только на оценке качества содержания, логики изложения и оформления работ студентов.

## Что изменено

### 1. Модель данных (`app/models.py`)
- Добавлено поле `ai_check_enabled` (Boolean, по умолчанию `True`) в модель `Room`
- Это поле определяет, будет ли проводиться проверка на AI-генерацию

### 2. Интерфейс комнаты (`app/templates/room.html`)
- Добавлен переключатель (checkbox) для включения/отключения AI проверки
- Переключатель расположен в разделе "Модуль автоматизированной экспертизы"
- Отображается текущее состояние проверки с пояснением

### 3. Маршруты (`app/routes.py`)
- Добавлена обработка действия `toggle_ai_check` для сохранения состояния переключателя
- При создании комнаты `ai_check_enabled` устанавливается в `True`
- Параметр передается в систему фоновых задач

### 4. Фоновые задачи (`app/background.py`)
- `AutoCheckJob` теперь принимает параметр `ai_check_enabled`
- Параметр передается в функцию `run_auto_checker`

### 5. Логика проверки (`auto_checker.py`)
- Создан **отдельный промпт для режима без AI проверки**, который сосредоточен на:
  * Качестве содержания (раскрытие темы, аргументация)
  * Логичности изложения
  * Оформлении работы
  * НЕ учитывает фактор AI-генерации

- При отключенной AI проверке (`ai_check_enabled=False`):
  * Функция `check_ai_generation()` **не вызывается** 
  * Используется упрощенный промпт без анализа признаков AI
  * Оценка основана только на академических критериях

- Все функции проверки обновлены для передачи параметра:
  * `get_binary_evaluation()` - выбор промпта в зависимости от режима
  * `process_submission()` - условный вызов AI детекции
  * `process_all_submissions()` - передача параметра
  * `run_auto_checker()` и `run_auto_checker_async()` - логирование режима

## Промпты

### Режим С AI проверкой (по умолчанию)
Проверяет работы по всем критериям, включая признаки AI-генерации:
- Содержание и раскрытие темы
- Логика и аргументация
- Оформление
- **Признаки AI-генерации** (шаблонность, отсутствие личных формулировок и т.д.)

### Режим БЕЗ AI проверки
Проверяет работы только по академическим критериям:
- Содержание и раскрытие темы
- Логика и аргументация  
- Оформление
- **НЕ проверяет** на AI-генерацию

Промпт явно указывает: *"ВАЖНО: В этой проверке НЕ учитывается фактор AI-генерации. Сосредоточься ТОЛЬКО на качестве содержания, логике изложения и оформлении."*

## Миграция базы данных

Для добавления нового поля в существующую базу данных был создан скрипт миграции:
```bash
python3 migrate_add_ai_check_field.py
```

Миграция:
- Добавляет поле `ai_check_enabled` в таблицу `rooms`
- Устанавливает значение `True` для всех существующих комнат (проверка включена)
- Безопасно обрабатывает случай, когда поле уже существует

## Использование

1. Откройте страницу комнаты
2. В разделе "Модуль автоматизированной экспертизы" найдите переключатель "Включить проверку на AI-генерацию"
3. Снимите галочку, чтобы отключить AI проверку
4. Система автоматически сохранит настройку
5. Все последующие проверки в этой комнате будут выполняться в выбранном режиме

## Логирование

В логах теперь отображается режим проверки:
```
AI проверка: включена
```
или
```
AI проверка: отключена
```

## Технические детали

- Параметр передается через всю цепочку: `routes.py` → `background.py` → `auto_checker.py`
- Условный вызов `check_ai_generation()` снижает нагрузку на API при отключенной AI проверке
- Разные промпты для разных режимов обеспечивают точную настройку оценки
- Миграция базы данных выполнена с учетом обратной совместимости

## Файлы изменений

1. `app/models.py` - модель Room
2. `app/routes.py` - обработка переключателя
3. `app/templates/room.html` - UI переключателя
4. `app/background.py` - передача параметра в фоновые задачи
5. `auto_checker.py` - логика проверки и промпты
6. `migrate_add_ai_check_field.py` - скрипт миграции БД

---

**Дата изменений:** 15 октября 2025  
**Автор:** AI Assistant


