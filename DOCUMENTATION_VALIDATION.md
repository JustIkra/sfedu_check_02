## Валидация и дедупликация итоговой ведомости (минимальные изменения)

### Цели

- В итоговую таблицу включать все результаты (и «зачтено», и «не зачтено»).
- Исключать дубликаты одного студента: оставлять ровно одну строку на студента.
- Сохранить структуру итоговой таблицы без добавления новых колонок.

### Фактическая структура итоговой таблицы (по образцам из `example`)

Оставляем строго следующие колонки в итоговом Excel:
- `Студент`
- `Результат`
- `AI-детекция`
- `AI-детали`
- `Комментарий`
- `Путь к файлу`

Примечание: служебные поля вида `__parsed_fio__`, `__parsed_id__`, `__submission_type__` использовать только во внутренней логике и НЕ добавлять в финальную таблицу.

### Где вносить изменения

- Функция: `auto_checker.generate_final_summary(root_dir)`.
- Место: блок после накопления списка записей (перед формированием `DataFrame` и сохранением в Excel).

### Идентификация студента (внутренняя логика)

- Ключ студента: `student_id` (если удалось извлечь) иначе нормализованное ФИО (`casefold()` + обрезка пробелов, NFC).
- Источники: поле `student` в `result.txt` и/или имя каталога; ID можно извлечь регулярными выражениями (`ID[:=]\s*(\w{3,})`, `\[(?:id|ID)=(\w+)\]`).

- Практический шаблон имени (Moodle): `ФИО_ИД_assignsubmission_<тип>`
  - Пример: `Ажогина Татьяна Николаевна_78290_assignsubmission_onlinetext`
  - Regex для извлечения: `^(.+?)_(\d+)_assignsubmission_(\w+)$`
    - группы: `fio`, `id`, `submission_type`
  - Для ключа дедупликации используем `id` при наличии; колонка `Студент` сохраняет исходное значение без изменений.

### Структура данных (откуда берутся поля)

- Источник сырых данных: файлы `result.txt` в подпапках студентов (создаются функцией `process_submission`).
- Формат `result.txt` — JSON следующего вида:

```json
{
  "student": "Ажогина Татьяна Николаевна_78290_assignsubmission_onlinetext",
  "file": "onlinetext.html",
  "date": "2025-10-17 04:57:28",
  "result": "зачтено",
  "comment": "Работа соответствует критериям...",
  "ai_detection": {
    "ai_detected": true,
    "confidence": "средняя",
    "reasons": [
      "Текст написан академическим стилем, без личных выражений.",
      "Используются обобщения без конкретных примеров."
    ],
    "comment": "Текст выглядит как краткое описание проекта..."
  },
  "checked_by": "SFEDU"
}
```

Схема полей (факт):
- `student: str` — имя студента; в Moodle-формате может содержать ID и тип отправки (`ФИО_ИД_assignsubmission_<тип>`).
- `file: str` — имя исходного файла студента (`.docx`/`.doc`/`onlinetext.html`).
- `date: str` — дата/время проверки в формате `YYYY-MM-DD HH:MM:SS`.
- `result: str` — «зачтено» или «не зачтено».
- `comment: str` — комментарий к результату.
- `ai_detection: object | null` — блок детекции AI (может отсутствовать):
  - `ai_detected: bool`
  - `confidence: "низкая" | "средняя" | "высокая"`
  - `reasons: string[]` — необязательный список причин
  - `comment: str` — необязательный текстовый разбор
- `checked_by: str` — сигнатура подсистемы проверки (например, "SFEDU").

- Поля, которые извлекаются из `result.txt` и используются для построения итоговой строки:
  - `student` → колонка `Студент` (строка; сохраняем как есть, включая суффиксы);
  - `result` → колонка `Результат` (строка: «зачтено»/«не зачтено»);
  - `ai_detection.ai_detected` + `ai_detection.confidence` → колонка `AI-детекция` (пример: «Да (средняя)», «Да (высокая)», «Нет», «Не проверено»);
  - `ai_detection.comment`, иначе объединённые `ai_detection.reasons` → колонка `AI-детали` (строка);
  - `comment` → колонка `Комментарий` (строка);
  - путь к файлу `result.txt` → колонка `Путь к файлу` (строка).

- Внутренние служебные поля (для дедупликации, не попадают в Excel):
  - `student_id: str | None` — извлекается из `student`/имени папки по regex;
  - `normalized_student: str` — нормализованное ФИО (NFC, trim, `casefold()`);
  - `parsed_date: datetime | None` — дата из `date` (если отсутствует — берём `mtime` файла);
  - `mtime: float` — время изменения `result.txt` из файловой системы (fallback).

- Ключ дедупликации: `key = student_id if student_id else normalized_student`.

- Итоговая таблица (строго 6 колонок):
  - `Студент: str`
  - `Результат: str` — «зачтено»/«не зачтено»
  - `AI-детекция: str` — «Да (высокая/средняя/низкая)» | «Нет» | «Не проверено»
  - `AI-детали: str` — причины/комментарий детекции или «Проверка не выполнялась»
  - `Комментарий: str`
  - `Путь к файлу: str`

### Алгоритм дедупликации (без изменения состава колонок)

1) Собрать все записи из `result.txt` (как сейчас).
2) Построить ключ студента: `key = student_id if student_id else normalized_student`.
3) Для каждого `key` выбрать одну «лучшую» запись по приоритетам:
   - приоритет 1: записи с результатом «зачтено» предпочтительнее «не зачтено»;

4) Сформировать итоговый `DataFrame` из выбранных записей и сохранить Excel с теми же шестью колонками.

### Детали реализации

- При чтении `result.txt`:
  - безопасно парсить JSON; при ошибке пропускать запись или использовать fallback;
  - пытаться распарсить `date` → `datetime` (иначе mtime);
  - извлечь `student_id` по regex (если есть), нормализовать ФИО для ключа.
- После накопления записей:
  - не фильтровать по значению `Результат` — включаются любые;
  - сгруппировать по ключу студента и выбрать одну запись по приоритетам: «зачтено» 
  - перед сохранением в Excel убедиться, что выводятся только колонки: `Студент`, `Результат`, `AI-детекция`, `AI-детали`, `Комментарий`, `Путь к файлу`.

### Пример маппинга (на основе result.txt)

Исходные данные:
```
student: "Ажогина Татьяна Николаевна_78290_assignsubmission_onlinetext"
result: "зачтено"
ai_detection: { ai_detected: true, confidence: "средняя", comment: "..." }
comment: "Работа соответствует критериям..."
```

Строка в итоговой таблице:
- `Студент`: «Ажогина Татьяна Николаевна_78290_assignsubmission_onlinetext»
- `Результат`: «зачтено»
- `AI-детекция`: «Да (средняя)»
- `AI-детали`: текст из `ai_detection.comment`
- `Комментарий`: текст из `comment`
- `Путь к файлу`: абсолютный путь к текущему `result.txt`

### Обработка спорных случаев

- У студента несколько «зачтено»: выбрать самую позднюю по `date` (или mtime).
- Смешанные результаты («зачтено» и «не зачтено»): оставить «зачтено» (если есть), при множестве — самую позднюю.
- Только «не зачтено» у студента: оставить самую позднюю.
- Совпадающее ФИО у разных людей без ID: логировать предупреждение; при коллизии дополнить ключ путём каталога для различения.

### Тестирование (минимальный чек-лист)

1) Подготовить архив с дубликатами:
   - Студент A: «не зачтено» и «зачтено» → в итоговой одна строка «зачтено».
   - Студент B: два «зачтено» с разными датами → в итоговой более поздняя.
   - Студент C: только «не зачтено» → отсутствует в итоговой.
2) Запустить проверку в интерфейсе комнаты.
3) Скачать итоговую ведомость — убедиться, что есть только базовые 6 колонок и по одной строке на студента.



### Полезные файлы и пути

- Основная логика формирования ведомости и точка внесения изменений:
  - `/home/user/maksim_project/sfedu_check_02/auto_checker.py` → функции: `generate_final_summary`, `run_auto_checker_async`, `process_submission`, `find_all_submissions`.

- Веб-интерфейс (запуск проверки, скачивание отчётов):
  - `/home/user/maksim_project/sfedu_check_02/app/routes.py`

- Модель комнаты (флаги и промпты проверки):
  - `/home/user/maksim_project/sfedu_check_02/app/models.py` → класс `Room`.

- Примеры итоговых ведомостей для ориентира структуры колонок:
  - Оригинал: `/home/user/maksim_project/sfedu_check_02/example/Итоговая_ведомость_ИИ_в_образовании_и_науке_Задание_№2_Исследование_применения_технологий (2)_20251016_182635_31feb55e(1).xlsx`
  - Версия с дедупликацией (служебные поля присутствуют, в релиз не включать): `/home/user/maksim_project/sfedu_check_02/example/Итоговая_ведомость_ИИ_в_образовании_и_науке_Задание_№2_Исследование_применения_технологий (2)_20251016_182635_31feb55e(1)_dedup.xlsx`

- Рабочее пространство и результаты отдельных студентов (пример):
  - Каталог комнаты: `/home/user/maksim_project/sfedu_check_02/instance/data/3d76ffe3-fc01-4bfc-a942-b382b3f0f932/`
  - Итоги (выгружаемые XLSX): `/home/user/maksim_project/sfedu_check_02/instance/data/3d76ffe3-fc01-4bfc-a942-b382b3f0f932/reports/`
  - Рабочая директория архива: `/home/user/maksim_project/sfedu_check_02/instance/data/3d76ffe3-fc01-4bfc-a942-b382b3f0f932/workspace/`
  - Пример `result.txt`: `/home/user/maksim_project/sfedu_check_02/instance/data/3d76ffe3-fc01-4bfc-a942-b382b3f0f932/workspace/ИИ_в_образовании_и_науке_Задание_№2_Исследование_применения_технологий (2)/Ажогина Татьяна Николаевна_78290_assignsubmission_onlinetext/result.txt`
